{% extends 'base.html' %}

{% load static %}
{% block link %}
  <link rel="stylesheet" href="{% static 'css/button.css' %}">
  <link rel="stylesheet" href="{% static 'css/products_detail.css' %}">
{% endblock link %}
{% block style %}
<style>
  .button--color {
    background-color: var(--main-color);
    color: white;
    padding: 10px;
    border: solid 1px var(--main-color);
  }

  .star {
    display: inline-block;
    font-size: 25px;
    color: #ccc;
    cursor: pointer;
  }

  .star-filled {
    color: #ffca08;
  }
  .star-filled-half {
    color: #ffca08;
    transform: scaleX(0.5);
  }
  .stars-inner {
    position: absolute;
    top: 0;
    left: 0;
    white-space: nowrap;
    width: 0;
    height: 100%;
    overflow: hidden;
    z-index: 1;
  }
  
  .star-input {
    display: inline-block;
  }

  .star-input input {
    display: none;
  }

  .star-input label {
    font-size: 30px;
    color: gray;
    display: inline-block;
    cursor: pointer;
    width: 30px;
    height: 30px;
    text-align: center;
    line-height: 30px;
  }

  .star-input label:before {
    content: '\2605';
    font-size: 30px;
  }

  .star-input input:checked ~ label:before,
  .star-input label:hover:before {
    content: '\2605';
    color: gold;
  }

  .star-input input:checked ~ label {
    color: gold;
  }

  .star-input input:checked ~ label:nth-child(1) ~ label:before {
    content: '\2605';
    color: gold;
  }

  .star-input input:checked ~ label:nth-child(1) ~ label:nth-child(2):before {
    content: '\2605';
    color: gold;
  }

  .star-input input:checked ~ label:nth-child(3) ~ label:nth-child(-n+3):before {
    content: '\2605';
    color: gold;
  }

  .star-input input:checked ~ label:nth-child(4) ~ label:nth-child(-n+4):before {
    content: '\2605';
    color: gold;
  }

  .star-input input:checked ~ label:nth-child(5) ~ label:before {
    content: '\2605';
    color: gold;
  }
</style>
{% endblock style %}


{% block content %}
<div class='d-flex row main--padding'>
  <p class='category--style'>{{ product.category }}</p>
  <div class='d-flex justify-content-between align-items-center'>
    <p class='title--font title--style'>{{ product.name }}</p>
    
      <p>태그 :
  {% for tag in tags %}
     {{tag}},
  {% endfor %}</p>

    
    {% comment %} <form class="like-form" data-product-id="{{ product.pk }}"> {% endcomment %}
    <form action="{% url 'products:likes' product.pk %}" method='POST' >
      {% csrf_token %}
      {% if request.user in product.like_users.all %}
        <button type='submit' class="bi bi-heart-fill title--likescount btn" id="like-btn"></button>
        {% else %}
        <button type='submit' class="bi bi-heart title--likescount btn" id="like-btn"></button>
      {% endif %}
      <span id="like-count">{{product.like_users.count}}</span> 
    </form>
  </div>
  <hr>

  {% if product.photo %}
  <div class='text-center'>
    <img src="{{product.photo.url}}" alt="image" class='content--image'>
  </div>
  {% endif %} 

  <p class='content--style'>{{ product.content }}</p>
  <hr>


  <h5>댓글 <span class='review--color'>{{reviews|length}}</span></h5>
  <div></div>
  <div class='container'>
    <form action="{% url 'products:review_create' product.pk %}" method="POST" enctype="multipart/form-data">
      {% csrf_token %}
      <div class='row'>
        <div class='col-10 p-0'>
          {{ review_form.content }}
          <div class='d-flex my-3 align-items-center'>
            <div>{{ review_form.rating }}</div>
            <div class='review--image__padding'>{{ review_img.image }}</div>
          </div>
        </div>
        <div class='col-2 p-0'>
          <input type="submit" value="리뷰 작성" class='button--color rounded btn--size'>
        </div>
      </div>
    </form>
  </div>

  {% for review in reviews %}
    <div class='container'>
      <div class='row mb-2'>
        <span class='col-2 review--user'>{{review.user}}</span>
        <span class='col-8'>{{review.content}}</span>
        <span class='col-2 review--updated_at'>{{review.updated_at|date:"Y-m-d"}}</span>

      </div>
      {% for review_img in review.review_image_set.all %}
        {% if review_img.image %}
          <div>
            <img class='content--image' src="{{ review_img.image.url }}" alt="review.img">
          </div>
          {% endif %}
      {% endfor %}
    </div>

  <div class='d-flex justify-content-between'>

    <form action="{% url 'products:review_likes' product.pk review.pk %}">
      {% csrf_token %}
      {% if request.user in review.like_users.all %}
      <button type='submit' class="bi bi-heart-fill title--likescount btn fs-4" id="review-like-btn"></button>
      {% else %}
      <button type='submit' class="bi bi-heart title--likescount btn fs-4" id="review-like-btn"></button>
      {% endif %}
    </form>
    
    <div class='d-flex mb-2'>
      {% if request.user == review.user %}
      <form action="{% url 'products:review_delete' product.pk review.pk %}" method='POST'>
        {% csrf_token %}
        <button type="submit" class="subtle--button--color rounded me-2">삭제</button>
      </form>
      
      <!-- Button trigger modal -->
      <button type="button" class="button--color rounded edit--model--botton" data-bs-toggle="modal" data-bs-target="#edit">
        수정
      </button>
    
      <!-- Modal -->
      <div class="modal fade" id="edit" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="editLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h1 class="modal-title fs-5" id="editLabel">리뷰 수정</h1>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <form action="{% url 'products:review_update' product.pk review.pk %}" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                {{ review_form.as_p }}
                {{ review_img.as_p }}
                {% comment %} <input type="submit"> {% endcomment %}
              </div>
              <div class="modal-footer">
                <button type="button" class="subtle--button--color rounded" data-bs-dismiss="modal">Close</button>
                <button type="submit" class="btn button--color rounded">수정</button>
              </form>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
      </div>
    </div>
    <hr>
    {% endfor %}

    {% endblock content %}
    {% block script %}
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>

    {% comment %} const forms = document.querySelectorAll(".like-form")
    const csrftokenLike = document.querySelector("[name=csrfmiddlewaretoken]").value

    forms.forEach((form) => {
      form.addEventListener('submit', function(e) {
        e.preventDefault()
        const productId = e.target.dataset.productId
        axios({
          method: 'post',
          url: `/products/${productId}/likes/`,
          headers: { "X-CSRFToken": csrftokenLike},
        }).then((response) => {
          const isLiked = response.data.is_liked
          const likeBtn = form.querySelector(`#like-btn`)
          if (isLiked){
            likeBtn.className = 'bi bi-heart-fill'
          } else{
            likeBtn.className = 'bi bi-heart'
          }

          const likeCountTag = form.querySelector('#like-count')
          const likeCountData = response.data.like_count
          likeCountTag.textContent = likeCountData
        })
        .catch((error) => {
          console.log(error.response)
        })
      })
    }) {% endcomment %}


  </script>
  {% endblock script %}
</body>
</html>
  <script>

    const starInputs = document.querySelectorAll('.star-input input');
    const starLabels = document.querySelectorAll('.star-input label');

    for (let i = 0; i < starInputs.length; i++) {
      starInputs[i].addEventListener('click', function () {
        for (let j = 0; j <= i; j++) {
          starLabels[j].classList.add('checked');
        }

        for (let j = i + 1; j < starInputs.length; j++) {
          starLabels[j].classList.remove('checked');
        }
      });
    }
  </script>
{% endblock content %}
